name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
  workflow_dispatch:  # Add for manual triggering if needed

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONUNBUFFERED: "1"

jobs:
  ci:
    # Run on all triggers, but output if it's a SemVer tag for downstream workflows
    runs-on: ubuntu-latest
    outputs:
      is_tag:     ${{ steps.decide.outputs.is_tag }}
      tag:        ${{ steps.decide.outputs.tag }}
      version:    ${{ steps.decide.outputs.version }}

    steps:
      - name: Determine target SHA
        id: sha
        run: echo "value=${{ github.sha }}" >> "$GITHUB_OUTPUT"

      - name: Checkout (tags + history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.sha.outputs.value }}

      - name: Ensure tags present
        run: git fetch --tags --force --prune

      - name: Decide if SemVer tag
        id: decide
        shell: bash
        run: |
          set -euo pipefail
          SHA="${{ steps.sha.outputs.value }}"
          TAGS=$(git tag --points-at "$SHA" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' || true)
          if [ -z "$TAGS" ] && [ "${{ github.event_name }}" = "push" ]; then
            if [[ "${GITHUB_REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              TAGS="${GITHUB_REF_NAME}"
            fi
          fi
          if [ -z "$TAGS" ]; then
            echo "is_tag=false"  >> "$GITHUB_OUTPUT"
            exit 0
          fi
          TAG=$(echo "$TAGS" | head -n1)
          VERSION=${TAG#v}
          {
            echo "is_tag=true"
            echo "tag=$TAG"
            echo "version=$VERSION"
          } >> "$GITHUB_OUTPUT"

  tests:
    name: tests (${{ matrix.toxenv }})
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - python-version: "3.11"
            toxenv: "py311"
          - python-version: "3.12"
            toxenv: "py312"
          - python-version: "3.13"
            toxenv: "py313"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix['python-version'] }}
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            requirements/**/*.txt

      - run: python -m pip install -U pip tox
      - run: tox -vv -e ${{ matrix.toxenv }}

      - name: Upload test artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: test-${{ matrix.toxenv }}
          path: artifacts/test/**
          if-no-files-found: ignore
          retention-days: 14

      - name: Upload coverage
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.toxenv }}
          path: artifacts/test/coverage.xml
          if-no-files-found: warn
          retention-days: 14

  checks:
    name: ${{ matrix.env }}
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        env: [quality, security, docs, build, api, sbom, citation]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            requirements/**/*.txt

      - uses: actions/setup-node@v4
        if: ${{ matrix.env == 'api' }}
        with:
          node-version: "20"

      - run: python -m pip install -U pip tox
      - run: tox -vv -e ${{ matrix.env }}

      - name: Upload artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.env }}
          path: artifacts/${{ matrix.env }}/**
          if-no-files-found: ignore
          retention-days: 14

  lint:
    name: lint
    runs-on: ubuntu-latest
    needs: [tests, checks]
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            requirements/**/*.txt

      - run: python -m pip install -U pip tox
      - run: tox -vv -e lint

      - name: Upload lint artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: lint
          path: artifacts/lint/**
          if-no-files-found: ignore
          retention-days: 14

  all-success:
    name: All CI Successful
    runs-on: ubuntu-latest
    needs: [ci, tests, checks, lint]
    if: always()

    steps:
      - name: Check all jobs success
        shell: bash
        run: |
          if [[ "${{ needs.tests.result }}" != "success" || "${{ needs.checks.result }}" != "success" || "${{ needs.lint.result }}" != "success" ]]; then
            exit 1
          fi
